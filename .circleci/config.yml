version: 2.1

jobs:
  test_vpn_connection:
    machine:
      image: ubuntu-2204:current   # üî• pe≈Çna maszyna, dzia≈Ça TUN/TAP
    steps:
      - checkout

      - run:
          name: Instalacja OpenVPN
          command: |
            sudo apt-get update
            sudo apt-get install -y openvpn
  
      - run:
          name: Start VPN
          command: |
            echo "$VPN_CONFIG" | base64 --decode > client.ovpn

            # üî• je≈õli w Twoim .ovpn NIE ma redirect-gateway,
            # mo≈ºesz odkomentowaƒá poni≈ºsze:
            echo "redirect-gateway def1" >> client.ovpn

            sudo openvpn --config client.ovpn --daemon --log /tmp/ovpn.log
            
            echo "Czekam na ustanowienie tunelu..."
            sleep 20

            echo "==== LOG OpenVPN ===="
            tail -n 100 /tmp/ovpn.log || true

      - run:
          name: Weryfikacja tunelu
          command: |
            echo "=== Interfaces ==="
            ip a

            echo "=== Routing ==="
            ip route

            echo "=== Test IP ==="
            curl -s https://ifconfig.me/ip
            echo

      - run:
          name: Instalacja zale≈ºno≈õci
          command: npm install

      - run:
          name: Uruchomienie test√≥w Cypress
          command: npx cypress run --browser electron --spec "cypress/e2e/vpn-test.cy.js"


workflows:
  pipeline:
    jobs:
      - test_vpn_connection:
          filters:
            branches:
              only: main
